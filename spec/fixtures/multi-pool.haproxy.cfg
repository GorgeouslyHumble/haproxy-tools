global
	log 127.0.0.1   local2 info
	maxconn 20000
#	ulimit-n 8250
	chroot /home/haproxy
	user haproxy
	group haproxy
	daemon
	quiet
	pidfile /home/haproxy/haproxy.pid
defaults
	log     global
	mode    http
	option  httplog
	option  dontlognull
	retries 3
	redispatch
	maxconn 10000
	contimeout      5000
	clitimeout      60000
	srvtimeout      60000
	stats uri /gz-haproxy-status
	cookie SERVERID insert indirect nocache

frontend www *:85
	default_backend g3
	# Now only when cookie is set to 'a' or 'b' using '?force_classic=true' or '?force_beta=true'
	acl classic_cookie hdr_reg(Cookie) split_to_site=a

	acl g4g_url url_dir gazelle-for-good

	# All non-www.gazelle* traffic needs to go to classic site
	# NB: No rule for 'gazelle.com' since this is dealt with by Apache before being sent to proxy
	acl main_gz_hostname hdr_beg(Host) -i www.gazelle

	acl walmart_hostname hdr_beg(Host) -i walmart.gazelle
	acl walmart_hostname hdr_beg(Host) -i m0-walmart.gazelle
	acl walmart_hostname hdr_beg(Host) -i m1-walmart.gazelle
	acl walmart_hostname hdr_beg(Host) -i m2-walmart.gazelle
	acl walmart_hostname hdr_beg(Host) -i m3-walmart.gazelle

	acl iss_hostname hdr_beg(Host) -i odisiss.gazelle
	acl iss_hostname hdr_beg(Host) -i m0-iss.gazelle
	acl iss_hostname hdr_beg(Host) -i m1-iss.gazelle
	acl iss_hostname hdr_beg(Host) -i m2-iss.gazelle
	acl iss_hostname hdr_beg(Host) -i m3-iss.gazelle

	acl logs_hostname hdr_beg(Host) -i logs.gazelle

	#These ACLs will match hosts in all environments (backstage, staging, prod) without resorting
	#to expensive regexes
	acl g3_media_subdomain hdr_beg(Host) -i m0-beta.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m1-beta.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m2-beta.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m3-beta.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m0-g3.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m1-g3.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m2-g3.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m3-g3.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m0.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m1.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m2.gazelle
	acl g3_media_subdomain hdr_beg(Host) -i m3.gazelle
        acl g3_media_subdomain hdr_beg(Host) -i m0-www.gazelle
        acl g3_media_subdomain hdr_beg(Host) -i m1-www.gazelle
        acl g3_media_subdomain hdr_beg(Host) -i m2-www.gazelle
        acl g3_media_subdomain hdr_beg(Host) -i m3-www.gazelle
	acl classic_media_subdomain hdr_beg(Host) -i classic0-www.gazelle
	acl classic_media_subdomain hdr_beg(Host) -i classic1-www.gazelle
	acl classic_media_subdomain hdr_beg(Host) -i classic2-www.gazelle
	acl classic_media_subdomain hdr_beg(Host) -i classic3-www.gazelle

	acl boldchat_media_host url_beg /images/boldchat/

	# 3.8 launch 28 Dec 2010: Bots initially still sent to classic
	# After postdeploy tasks, REMOVE THESE RULES and update .tmpl file for LB
	#acl bot hdr_reg(User-Agent) Googlebot
	#acl bot hdr_reg(User-Agent) Yahoo
	#acl bot hdr_beg(User-Agent) msnbot

	# clicktale - all should go to G3
	acl clicktale hdr_beg(User-Agent) -i ClickTale

        acl staples_hostname hdr_beg(Host) -i staples.gazelle
        acl staples_hostname hdr_beg(Host) -i m0-staples.gazelle
        acl staples_hostname hdr_beg(Host) -i m1-staples.gazelle
        acl staples_hostname hdr_beg(Host) -i m2-staples.gazelle
        acl staples_hostname hdr_beg(Host) -i m3-staples.gazelle
        use_backend staples if staples_hostname

	# force site rules
	acl force-beta	  url_end	 force_beta=true
	acl force-classic	url_end	 force_classic=true

	use_backend logs if logs_hostname
	use_backend iss if iss_hostname
	use_backend walmart if walmart_hostname

	use_backend classic if force-classic
	use_backend classic if force-beta
	use_backend classic if g4g_url
	use_backend classic if classic_media_subdomain
	use_backend classic if boldchat_media_host
	#After 3.8 postdeploy tasks remove below line and above 'acl bot' rules,
	# then reload HAProxy and update .tmpl file
	#use_backend classic if bot
	use_backend g3 if clicktale
	use_backend g3 if g3_media_subdomain
	use_backend classic if classic_cookie
	use_backend classic if !main_gz_hostname

## should do a redirect if includes SRAPI hostname or path?


backend g3
	mode http
	balance roundrobin
	option httpchk GET /up
	server prod_g3_500d 10.100.173.217:8000 cookie i-011b9f62 check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_g3_503c 10.214.78.95:8000 cookie i-552fab36 check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_g3_502d 10.99.89.233:8000 cookie i-7f2fab1c check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_g3_501c 10.7.22.40:8000 cookie i-752fab16 check inter 3000 rise 2 fall 3 maxconn 1000
	server fake_g3 127.0.0.1:9999 backup
	server prod_g3_505c 10.210.146.127:8000 cookie i-292fab4a check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_g3_504d 10.84.126.16:8000 cookie i-212fab42 check inter 3000 rise 2 fall 3 maxconn 1000

backend staples
        mode http
        balance roundrobin
        option httpchk GET /up
	server fake_staples 127.0.0.1:9999 backup
	server prod_staples_501c 10.210.125.43:8000 cookie i-5bda5d38 check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_staples_500d 10.245.39.31:8000 cookie i-25cc4b46 check inter 3000 rise 2 fall 3 maxconn 1000

backend walmart
        mode http
        balance roundrobin
        option httpchk GET /up
	server fake_wmt 127.0.0.1:9999 backup
	server prod_wmt_501c 10.200.117.118:8000 cookie i-937afef0 check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_wmt_502d 10.243.145.157:8000 cookie i-997afefa check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_wmt_500d 10.244.111.105:8000 cookie i-c77afea4 check inter 3000 rise 2 fall 3 maxconn 1000

backend classic
        mode http
        balance roundrobin
        option httpchk GET /
	server fake_rtis 127.0.0.1:9999 backup
	server prod_rtis_as_500d 10.245.1.5:8000 cookie i-ad36b2ce check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_rtis_as_502d 10.194.197.123:8000 cookie i-bb36b2d8 check inter 3000 rise 2 fall 3 maxconn 1000
	server prod_rtis_as_501c 10.241.127.66:8000 cookie i-b136b2d2 check inter 3000 rise 2 fall 3 maxconn 1000

backend logs
	mode http
	balance roundrobin
	option httpchk GET /ping
	server prod_logger_502d 10.245.174.75:8000 cookie i-4be86f28 check inter 3000 rise 2 fall 3 maxconn 1000
	server fake_logger 127.0.0.1:9999 backup
	server prod_logger_501c 10.215.157.10:8000 cookie i-43e86f20 check inter 3000 rise 2 fall 3 maxconn 1000

backend iss
        mode http
        balance roundrobin
        option httpchk GET /images/gazelle_powered.gif
	server fake_iss www.gazelle.com:8000 backup
